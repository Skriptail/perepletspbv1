import{h as a,$ as e,a3 as t,a0 as o,d as l,w as s,c as n,a5 as i,a1 as r,F as c,aa as u,ab as d,m as h,x as v,R as f,u as p,V as m,a6 as _,N as g}from"./vendor-OkV39SfI.js";import{u as k,k as b,j as y,l as w,m as x,V as C,a as V,b as q,c as H,_ as z,e as A,d as P,n as j,Q as I,f as F,g as U,h as D,o as E,p as R,q as S,i as $,r as M}from"./index-D8ZiVHsM.js";import"./vuetify-E21gszqs.js";const N=["width","height"],Q=["fill"],B=["fill"],G=a({__name:"HookahIcon",props:{size:{type:[Number,String],default:64},color:{type:String,default:"#A0A0A0"}},setup:a=>(l,s)=>(t(),e("svg",{width:a.size,height:a.size,viewBox:"0 0 512 512",fill:"none",xmlns:"http://www.w3.org/2000/svg"},[o("path",{d:"M275.869,362.688H118.99v0c-16.361,16.89-31.417,39.392-31.417,65.009c0,54.348,39.24,80.744,40.911,81.842l3.749,2.462 h130.393l3.749-2.462c1.67-1.098,40.911-27.494,40.911-81.842C307.286,402.08,292.23,379.578,275.869,362.688z",fill:a.color},null,8,Q),o("path",{d:"M414.095,193.633V158.07h-30v35.563h-10.333v30h10.333v2.7c0,13.05-10.617,23.667-23.666,23.667 c-13.05,0-23.667-10.617-23.667-23.667v-81c0-23.159-18.841-42-42-42h-34.637l-35.029,48.148 c-3.875-2.596-8.132-4.663-12.668-6.098v-51.93h32.44v-30h-32.44V30h14.666V0h-59.333v30h14.667v33.453h-32.441v30h32.441v51.93 c-20.175,6.381-34.842,25.274-34.842,47.532c0,22.257,14.667,41.15,34.842,47.531v20.655 c-20.175,6.381-34.842,25.274-34.842,47.531c0,8.721,2.265,16.917,6.218,24.055h87.248c3.953-7.138,6.218-15.334,6.218-24.055 c0-22.257-14.667-41.15-34.842-47.531v-20.655c20.175-6.381,34.842-25.274,34.842-47.531c0-5.92-1.043-11.6-2.945-16.872 l31.073-42.71h19.363c6.617,0,12,5.383,12,12v81c0,29.592,24.075,53.667,53.667,53.667c29.592,0,53.666-24.075,53.666-53.667v-2.7 h10.334v-30H414.095z",fill:a.color},null,8,B)],8,N))}),L={class:"hookah-icons"},T=y(a({__name:"HookahProgress",setup(a,{expose:v}){const f=k(),p=l(f.hookah_count);s((()=>f.hookah_count),(a=>{p.value=a}));const m=n((()=>p.value));return v({updateCount:a=>{p.value=void 0!==a?a:f.hookah_count},getCurrentCount:()=>p.value}),(a,l)=>(t(),i(b,{theme:"light",color:"white",rounded:!1,elevation:"1",class:"pa-4 pt-5 pb-6 pa-sm-5 hookah-progress",style:{"background-color":"white !important","border-radius":"0 !important"}},{default:r((()=>[o("div",L,[(t(),e(c,null,u(5,(e=>o("div",{key:e,class:d(["hookah-item",{active:e<=m.value}])},[l[0]||(l[0]=o("div",{class:"circle-background"},null,-1)),h(G,{size:32,class:d({"small-icon":a.$vuetify.display.xs}),color:e<=m.value?"#000000":"#4A4A4A"},null,8,["class","color"])],2))),64))])])),_:1}))}}),[["__scopeId","data-v-eeff6886"]]),J={class:"main-content pa-2 pa-sm-4 fade-in pt-6"},K={class:"mb-1 d-flex justify-space-between align-center"},O={class:"block-container mb-4"},W={class:"progress-container mb-3"},X={class:"block-container"},Y={class:"qr-section fade-in"},Z={class:"qr-code-container"},aa={class:"qr-code"},ea=y(a({__name:"GuestVoucher",setup(a){const s=k(),n=l(!1),u=l(null),d=l(!1),b=l(""),y=l(""),N=l(!1),Q=l(null);async function B(){var a;if(N.value)return;const e=await(null==(a=Q.value)?void 0:a.validate());if(null==e?void 0:e.valid){N.value=!0,y.value="";try{const a=s.telegram_id;if(!a)throw new Error("Не удалось получить ID пользователя");const e=await x.post("https://e-perepletspb.ru/api/register",{telegram_id:a,name:b.value});w.info("Ответ на регистрацию:",e.data),s.setUserData(e.data),d.value=!1,window.location.reload()}catch(t){w.error("Ошибка при регистрации:",t),y.value="Произошла ошибка при регистрации. Пожалуйста, попробуйте еще раз."}finally{N.value=!1}}}async function G(){n.value=!0;try{w.info("Состояние перед обновлением",{hookahCount:s.hookah_count,totalHookahCount:s.total_hookah_count});const a=await s.updateUserProgress();w.info("Данные, полученные от API",{responseData:a});let e=s.hookah_count;if(a&&"object"==typeof a&&"hookah_count"in a&&void 0!==a.hookah_count){const t=a.hookah_count;w.info("Получено значение hookah_count напрямую из API",{apiHookahCount:t}),e=t}u.value&&(w.info("Вызываем обновление компонента прогресса",{actualHookahCount:e}),u.value.updateCount(e),w.info("Компонент прогресса обновлен")),w.info("Прогресс обновлен",{hookahCount:s.hookah_count,totalHookahCount:s.total_hookah_count,providedHookahCount:e})}catch(a){w.error("Ошибка при обновлении прогресса",{error:a})}finally{n.value=!1}}return v((async()=>{await async function(){try{const a=s.telegram_id;if(!a)return;w.info("Проверка регистрации пользователя:",{telegramId:a});const e=await x.get(`https://e-perepletspb.ru/api/user/${a}`);!e.data||e.data.name&&""!==e.data.name.trim()?w.info("Пользователь уже зарегистрирован:",e.data.name):(w.info("Имя пользователя не задано, показываем форму регистрации"),d.value=!0)}catch(a){w.error("Ошибка при проверке регистрации:",a),d.value=!0}}(),await G()})),(a,l)=>(t(),e(c,null,[h(C,{class:"fill-height pa-0 pa-sm-4 voucher-container"},{default:r((()=>[h(q,{justify:"center",class:"fill-height ma-0"},{default:r((()=>[h(H,{cols:"12",md:"8",lg:"6",class:"pa-0 pa-sm-2"},{default:r((()=>[o("div",J,[l[9]||(l[9]=o("div",{class:"mb-4"},[o("img",{src:z,alt:"PEREPLËT",class:"logo"})],-1)),o("div",K,[l[4]||(l[4]=o("h1",{class:"text-h4 gradient-text"},"Программа лояльности",-1)),h(A,{icon:"",variant:"text",color:"#FFF100",onClick:G,loading:n.value,size:"small",class:"refresh-btn"},{default:r((()=>[h(P,null,{default:r((()=>l[2]||(l[2]=[f("mdi-refresh")]))),_:1}),h(j,{activator:"parent",location:"bottom"},{default:r((()=>l[3]||(l[3]=[f("Обновить прогресс")]))),_:1})])),_:1},8,["loading"])]),o("div",O,[o("div",W,[h(T,{ref_key:"hookahProgress",ref:u},null,512)]),l[5]||(l[5]=o("div",{class:"info-message text-center"},[o("p",{class:"text-subtitle-1 text-medium-emphasis mb-0"}," Все ваши купоны хранятся в личном кабинете ")],-1))]),o("div",X,[o("div",Y,[o("div",Z,[l[7]||(l[7]=o("div",{class:"qr-title text-left"},"Ваш QR-код",-1)),l[8]||(l[8]=o("div",{class:"qr-description text-left"},"Покажите его сотруднику для зачисления кальяна",-1)),o("div",aa,[p(s).qrCodePermanent?(t(),i(I,{key:0,data:p(s).qrCodePermanent,size:200,level:"H",renderAs:"svg",margin:"0",color:"#000000",background:"#ffffff"},null,8,["data"])):(t(),i(P,{key:1,size:"100",color:"grey"},{default:r((()=>l[6]||(l[6]=[f("mdi-qrcode")]))),_:1}))])])])])])])),_:1})])),_:1})])),_:1}),h(V,{modelValue:d.value,"onUpdate:modelValue":l[1]||(l[1]=a=>d.value=a),"max-width":"500",persistent:"",class:"register-dialog"},{default:r((()=>[h(F,{class:"pa-6"},{default:r((()=>[h(U,{class:"text-h5 pb-4"},{default:r((()=>l[10]||(l[10]=[f(" Завершите регистрацию ")]))),_:1}),h(D,null,{default:r((()=>[l[11]||(l[11]=o("p",{class:"text-subtitle-1 mb-6"},"Пожалуйста, введите ваше имя, чтобы завершить регистрацию",-1)),h(E,{ref_key:"registerForm",ref:Q,onSubmit:m(B,["prevent"])},{default:r((()=>[h(R,{modelValue:b.value,"onUpdate:modelValue":l[0]||(l[0]=a=>b.value=a),label:"Ваше имя",variant:"outlined",rules:[a=>!!a||"Имя обязательно для заполнения"],required:"",class:"mb-4"},null,8,["modelValue","rules"]),y.value?(t(),i(S,{key:0,type:"error",class:"mb-4"},{default:r((()=>[f(g(y.value),1)])),_:1})):_("",!0)])),_:1},512)])),_:1}),h($,{class:"pt-2"},{default:r((()=>[h(M),h(A,{color:"white",variant:"tonal",onClick:B,loading:N.value,class:"close-btn"},{default:r((()=>l[12]||(l[12]=[f(" Продолжить ")]))),_:1},8,["loading"])])),_:1})])),_:1})])),_:1},8,["modelValue"])],64))}}),[["__scopeId","data-v-a772863d"]]);export{ea as default};
